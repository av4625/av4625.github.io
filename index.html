<!DOCTYPE html>
<html>
    <head>
        <title>My Home</title>

        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />

        <link rel="stylesheet" href="css/floor_plan.css?ver=<?php echo time();?>" type="text/css"/>

        <script src="javascript/jquery-3.2.1.min.js" type="text/javascript"></script>
        <script src="javascript/room_colour.js?ver=<?php echo time();?>" type="text/javascript"></script>
        <script type="text/javascript">

            var living_room_light_rgb = [0, 0, 0];

            $(document).ready(function()
            {
                // Add Temperature to rooms
                ajax_calls();

                // Check for updated temperture every 10 seconds
                setInterval(function()
                {
                    ajax_calls();
                }, 1000*10);
            });

            // Get temperature from rooms, format it and set background colour for rooms
            function set_temperature(data)
            {
                var total_temp = 0;
                var total_weekly_temp = 0;
                var number_of_rooms = 0;

                Object.keys(data).forEach(function(room)
                {
                    var temp = parseFloat(data[room]['temperature']);
                    var avg_temp = parseFloat(data[room]['average_temperature']);
                    var is_old = is_date_old(data[room]['date']);

                    total_temp += temp;
                    total_weekly_temp += avg_temp;
                    number_of_rooms++;

                    // Set temperature rounded to 1 decimal place and with '*C' after it
                    $('div#' + room + ' p.temperature').html(temp.toFixed(1) + '&#8451;');

                    if (room === 'spare_bedroom' || room === 'study')
                    {
                        // Set the colour of the room and room hall
                        $('div.' + room).css('background-color', generate_room_colour(temp, is_old));
                    }
                    else
                    {
                        // Set the colour of the room
                        $('div#' + room).css('background-color', generate_room_colour(temp, is_old));
                    }

                    // Set emoji
                    set_image('div#' + room + ' img#' + room + '_emoji', get_image($('div#' + room).css('background-color'), is_old));
                });

                $('p#average_house_temp').html((total_temp / number_of_rooms).toFixed(1) + '&#8451;');
                $('p#weekly_average_house_temp').html((total_weekly_temp / number_of_rooms).toFixed(1) + '&#8451;');
            }

            // Set wether the lights are on or off
            function set_lights(light_status)
            {
                // Loop through json returned from tradfri
                Object.keys(light_status).forEach(function(light)
                {
                    // Check if the light is on
                    if (light_status[light][3311][0][5850])
                    {
                        if (light === 'living_room_light')
                        {
                            // Get colours of the living room light
                            var hue = light_status[light][3311][0][5707] / 65535;
                            var saturation = light_status[light][3311][0][5708] / 65535;
                            var rgb = hsv_to_rgb(hue, saturation, 1);

                            // If the colour has changed since last check draw the new image
                            if (!are_arrays_equal(rgb, living_room_light_rgb))
                            {
                                set_bulb_colour('img#' + light + '_emoji', rgb);
                                living_room_light_rgb = rgb;
                            }
                        }
                        else
                        {
                            // Set image src as the light bulb image
                            $('img#' + light + '_emoji').attr('src', 'images/light_bulb.png');
                        }

                        // Show image
                        $('img#' + light + '_emoji').show();
                    }
                    else
                    {
                        // Hide image if the light is off
                        $('img#' + light + '_emoji').hide();
                    }
                });
            }

            // Get temperature data from the database
            function ajax_calls()
            {
                var php_files = ['php/get_temperature.php', 'php/tradfri_status.php'];

                for (var i = 0; i < php_files.length; i++)
                {
                    $.ajax({
                        type: 'POST',
                        url: php_files[i],
                        success: function(result)
                        {
                            var json = JSON.parse(result);

                            if (this.url === 'php/tradfri_status.php')
                            {
                                set_lights(json);
                            }
                            else
                            {
                                set_temperature(json);
                            }
                        }
                    });
                }
            }
        </script>
    </head>
    <body>
        <div id="information">
            <h4 id="average_house_temp_header" class="info_headers">Average House Temperature</h4>
            <p id="average_house_temp" class="info_p"></p>
            <br/>
            <h4 id="week_average_house_temp_header" class="info_headers">Weekly Average House Temperature</h4>
            <p id="weekly_average_house_temp" class="info_p"></p>
        </div>
        <div id="outside_edge">
            <div id="bathroom" class="room">
                <p class="room_name">Bathroom</p>
            </div>

            <div id="kitchen" class="room">
                <p class="room_name">Kitchen</p>
                <p class="temperature"></p>
                <img id="kitchen_emoji" class="room_emoji" src=""/>
                <img id="kitchen_light_emoji" class="light_emoji" src=""/>
                <img id="living_room_light_emoji" class="light_emoji" src=""/>
            </div>

            <div id="hall" class="room">
                <p class="room_name">Hall</p>
            </div>

            <div id="bedroom" class="room">
                <p class="room_name">Bedroom</p>
                <p class="temperature"></p>
                <img id="bedroom_emoji" class="room_emoji" src=""/>
                <img id="bedroom_light_emoji" class="light_emoji" src=""/>
                <img id="bedroom_lamp_emoji" class="light_emoji" src=""/>
            </div>

            <div id="closet" class="room">
                <p class="room_name">Closet</p>
            </div>

            <div id="study" class="room study">
                <p class="room_name">Study</p>
                <p class="temperature"></p>
                <img id="study_emoji" class="room_emoji" src=""/>
            </div>
            <div id="study_hall" class="room study"></div>

            <div id="spare_bedroom" class="room spare_bedroom">
                <p class="room_name">Spare Bedroom</p>
                <p class="temperature"></p>
                <img id="spare_bedroom_emoji" class="room_emoji" src=""/>
            </div>
            <div id="spare_bedroom_hall" class="room spare_bedroom"></div>
        </div>
    </body>
</html>
