<!DOCTYPE html>
<html>
    <head>
        <title>My Home</title>

        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />

        <link rel="stylesheet" href="css/floor_plan.css?ver=<?php echo time();?>" type="text/css"/>

        <script src="https://www.gstatic.com/firebasejs/5.0.4/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.0.4/firebase-database.js"></script>
        <script src="javascript/jquery-3.2.1.min.js" type="text/javascript"></script>
        <script src="javascript/helper_functions.js?ver=<?php echo time();?>" type="text/javascript"></script>
        <script>
            // Initialize Firebase
            var config = {
                apiKey: "AIzaSyDyjwcOJ0TePhze4N9G7WdKiAQ5iOSebZw",
                authDomain: "house-temperature-c66ca.firebaseapp.com",
                databaseURL: "https://house-temperature-c66ca.firebaseio.com",
                projectId: "house-temperature-c66ca",
                storageBucket: "house-temperature-c66ca.appspot.com",
                messagingSenderId: "847481592400"
            };

            var number_of_rooms = 4;
            var current_room_temperatures = {
                'kitchen':       0,
                'bedroom':       0,
                'spare_bedroom': 0,
                'study':         0
            };
            var weekly_average_room_temperatures = {
                'kitchen':       0,
                'bedroom':       0,
                'spare_bedroom': 0,
                'study':         0
            };

            $(document).ready(function()
            {
                listeners();
            });

            firebase.initializeApp(config);

            var database = firebase.database();

            function get_week_number(key)
            {
                return parseInt(key.substring(5, key.length));
            }

            // Set the average temperature, and listen for a new week
            function set_average_temperature(room, data)
            {
                var current_key = Object.keys(data)[0];

                // If the current week is week_1 set the data
                if (current_key === 'week_1')
                {
                    // Set week one data
                    weekly_average_room_temperatures[room] = parseFloat(data[current_key]['total_temperature']) / parseFloat(data[current_key]['entries']);
                    set_weekly_averages();
                }
                // Else, Get data from previous week and set the average data
                else
                {
                    // Get data for the week before current (Unless week is 1)
                    var week_before_ref = database.ref(room + '/weeks/week_' + (get_week_number(current_key) - 1));
                    week_before_ref.once('value').then(function(snapshot)
                    {
                        // Set average for previous week
                        var data = snapshot.val();
                        weekly_average_room_temperatures[room] = parseFloat(data['total_temperature']) / parseFloat(data['entries']);
                        set_weekly_averages();
                    });
                }

                // Create a listener for the week after the current week
                    // Call this function again with week afters snapshot
                var week_after_ref = database.ref(room + '/weeks/week_' + (get_week_number(current_key) + 1));
                week_after_ref.on('value', function(snapshot)
                {
                    if (snapshot.val() != null)
                    {
                        week_after_ref.off();
                        listen_for_new_week(room, snapshot.val()['week_number']);
                    }
                });
            }

            // Sets the current average house temperature
            function set_current_average()
            {
                var total_temp = 0;

                Object.keys(current_room_temperatures).forEach(function(room)
                {
                    total_temp += current_room_temperatures[room];
                });

                $('p#average_house_temp').html((total_temp / number_of_rooms).toFixed(1) + '&#8451;');
            }

            // Sets the weekly average house temperature
            function set_weekly_averages()
            {
                var total_temp = 0;

                Object.keys(weekly_average_room_temperatures).forEach(function(room)
                {
                    total_temp += weekly_average_room_temperatures[room];
                });

                $('p#weekly_average_house_temp').html((total_temp / number_of_rooms).toFixed(1) + '&#8451;');
            }

            // Activate listeners to listen to firebase
            function listeners()
            {
                var current_bedroom_ref = database.ref('bedroom/current');
                current_bedroom_ref.on('value', function(snapshot)
                {
                    set_temperature('bedroom', snapshot.val());
                });

                var current_kitchen_ref = database.ref('kitchen/current');
                current_kitchen_ref.on('value', function(snapshot)
                {
                    set_temperature('kitchen', snapshot.val());
                });

                var current_spare_bedroom_ref = database.ref('spare_bedroom/current');
                current_spare_bedroom_ref.on('value', function(snapshot)
                {
                    set_temperature('spare_bedroom', snapshot.val());
                });

                var current_study_ref = database.ref('study/current');
                current_study_ref.on('value', function(snapshot)
                {
                    set_temperature('study', snapshot.val());
                });

                var weeks_bedroom_ref = database.ref('bedroom/weeks');
                weeks_bedroom_ref.orderByKey().limitToLast(1).once('value').then(function(snapshot)
                {
                    set_average_temperature('bedroom', snapshot.val());
                });

                var weeks_kitchen_ref = database.ref('kitchen/weeks');
                weeks_kitchen_ref.orderByKey().limitToLast(1).once('value').then(function(snapshot)
                {
                    set_average_temperature('kitchen', snapshot.val());
                });

                var weeks_spare_bedroom_ref = database.ref('spare_bedroom/weeks');
                weeks_spare_bedroom_ref.orderByKey().limitToLast(1).once('value').then(function(snapshot)
                {
                    set_average_temperature('spare_bedroom', snapshot.val());
                });

                var weeks_study_ref = database.ref('study/weeks');
                weeks_study_ref.orderByKey().limitToLast(1).once('value').then(function(snapshot)
                {
                    set_average_temperature('study', snapshot.val());
                });
            }
        </script>

        <script type="text/javascript">

            var living_room_light_rgb = [0, 0, 0];

            // Sets the room temperature, called when database updates
            function set_temperature(room, data)
            {
                var is_old = is_date_old(data['date_time']);
                var temperature = parseFloat(data['temperature']);
                current_room_temperatures[room] = temperature;

                // Set temperature rounded to 1 decimal place and with '*C' after it
                $('div#' + room + ' p.temperature').html(temperature.toFixed(1) + '&#8451;');

                if (room === 'spare_bedroom' || room === 'study')
                {
                    // Set the colour of the room and room hall
                    $('div.' + room).css('background-color', generate_room_colour(temperature, is_old));
                }
                else
                {
                    // Set the colour of the room
                    $('div#' + room).css('background-color', generate_room_colour(temperature, is_old));
                }

                // Set emoji
                set_image('div#' + room + ' img#' + room + '_emoji', get_image($('div#' + room).css('background-color'), is_old));

                // Set the average house temperature
                set_current_average();

            }

            // Set wether the lights are on or off
            function set_lights(light_status)
            {
                // Loop through json returned from tradfri
                Object.keys(light_status).forEach(function(light)
                {
                    // Check if the light is on
                    if (light_status[light][3311][0][5850])
                    {
                        if (light === 'living_room_light')
                        {
                            // Get colours of the living room light
                            var hue = light_status[light][3311][0][5707] / 65535;
                            var saturation = light_status[light][3311][0][5708] / 65535;
                            var rgb = hsv_to_rgb(hue, saturation, 1);

                            // If the colour has changed since last check draw the new image
                            if (!are_arrays_equal(rgb, living_room_light_rgb))
                            {
                                set_bulb_colour('img#' + light + '_emoji', rgb);
                                living_room_light_rgb = rgb;
                            }
                        }
                        else
                        {
                            // Set image src as the light bulb image
                            $('img#' + light + '_emoji').attr('src', 'images/light_bulb.png');
                        }

                        // Show image
                        $('img#' + light + '_emoji').show();
                    }
                    else
                    {
                        // Hide image if the light is off
                        $('img#' + light + '_emoji').hide();
                    }
                });
            }
        </script>
    </head>
    <body>
        <div id="information">
            <h4 id="average_house_temp_header" class="info_headers">Average House Temperature</h4>
            <p id="average_house_temp" class="info_p"></p>
            <br/>
            <h4 id="week_average_house_temp_header" class="info_headers">Weekly Average House Temperature</h4>
            <p id="weekly_average_house_temp" class="info_p"></p>
        </div>
        <div id="outside_edge">
            <div id="bathroom" class="room">
                <p class="room_name">Bathroom</p>
            </div>

            <div id="kitchen" class="room">
                <p class="room_name">Kitchen</p>
                <p class="temperature"></p>
                <img id="kitchen_emoji" class="room_emoji" src=""/>
                <img id="kitchen_light_emoji" class="light_emoji" src=""/>
                <img id="living_room_light_emoji" class="light_emoji" src=""/>
            </div>

            <div id="hall" class="room">
                <p class="room_name">Hall</p>
            </div>

            <div id="bedroom" class="room">
                <p class="room_name">Bedroom</p>
                <p class="temperature"></p>
                <img id="bedroom_emoji" class="room_emoji" src=""/>
                <img id="bedroom_light_emoji" class="light_emoji" src=""/>
                <img id="bedroom_lamp_emoji" class="light_emoji" src=""/>
            </div>

            <div id="closet" class="room">
                <p class="room_name">Closet</p>
            </div>

            <div id="study" class="room study">
                <p class="room_name">Study</p>
                <p class="temperature"></p>
                <img id="study_emoji" class="room_emoji" src=""/>
            </div>
            <div id="study_hall" class="room study"></div>

            <div id="spare_bedroom" class="room spare_bedroom">
                <p class="room_name">Spare Bedroom</p>
                <p class="temperature"></p>
                <img id="spare_bedroom_emoji" class="room_emoji" src=""/>
            </div>
            <div id="spare_bedroom_hall" class="room spare_bedroom"></div>
        </div>
    </body>
</html>
